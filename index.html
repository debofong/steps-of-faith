<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Route Planner ‚Äî Marina Bay Sands</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  :root{
    --accent: #ff7a00;
    --bg: #fff7f0;
    --muted: #5c5c5c;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  html,body{height:100%; margin:0; background:var(--bg);}
  .app { display:flex; flex-direction:row; height:100vh; gap:8px; padding:8px; box-sizing:border-box;}
  .map { flex:1; border-radius:12px; overflow:hidden; position:relative; }
  #map { height:100%; width:100%; }
  .panel {
    width:300px; background:#fffaf5; border-radius:12px; padding:12px;
    display:flex; flex-direction:column; gap:10px; box-sizing:border-box;
    font-size:14px; z-index:999;
  }
  button { padding:8px 10px; border-radius:8px; border:0; font:inherit; cursor:pointer; }
  button.primary { background:var(--accent); color:white; font-weight:600; }
  .small{font-size:12px; padding:6px 8px;}
  .lap-counter{display:flex;justify-content:space-between;align-items:center;background:#fff3e6;padding:8px;border-radius:8px;}
  .weather{background:#fff3e6;padding:8px;border-radius:8px;}
  .forecast{display:flex;gap:6px;}
  .forecast div{flex:1;text-align:center;background:#fff;border-radius:6px;padding:6px;font-size:12px;}
  .distance {background:#fff3e6;padding:8px;border-radius:8px;font-weight:600;}

  /* Floating menu button (mobile only) */
  #menuToggle {
    position:absolute;
    top:12px;
    left:12px;
    z-index:1000;
    background:var(--accent);
    color:white;
    border:none;
    border-radius:8px;
    padding:8px 12px;
    font-size:16px;
    cursor:pointer;
    display:none; /* hidden on desktop */
  }

  /* Mobile layout */
  @media (max-width:768px){
    .app { flex-direction:column; }
    .panel {
      position:absolute;
      top:0; right:0; bottom:0;
      width:80%; max-width:320px;
      height:100%;
      box-shadow:-2px 0 8px rgba(0,0,0,0.2);
      transform:translateX(100%);
      transition:transform 0.3s ease;
    }
    .panel.show { transform:translateX(0); }
    #menuToggle { display:block; }
  }
</style>
</head>
<body>

<div class="app">
  <div class="map">
    <div id="map"></div>
    <button id="menuToggle">‚ò∞ Menu</button>
  </div>

  <aside class="panel" id="sidePanel">
    <h3>Route Planner</h3>
    <div>
      <button id="undoBtn" class="small">‚Ü∂ Undo</button>
      <button id="clearBtn" class="small">üóë Clear</button>
      <button id="saveBtn" class="primary small">üíæ Save</button>
    </div>
    <input id="routeName" placeholder="Route name‚Ä¶" />
    <div id="savedList">No saved routes</div>

    <div class="location-setup">
      <b>Starting Location</b><br>
      <input id="postalCode" placeholder="Enter postal code‚Ä¶" />
      <button id="setLocationBtn" class="small">üìç Set Location</button>
      <div id="locationStatus" class="small" style="color:var(--muted)"></div>
    </div>

    <div class="lap-counter">
      <div>Laps: <span id="lapCount">0</span></div>
      <div>
        <button id="manualLap" class="small">+ Lap</button>
        <button id="resetLap" class="small">Reset</button>
      </div>
    </div>

    <div class="distance">
      Distance: <span id="distance">0.00</span> km
    </div>

    <div class="weather">
      <div><b>Weather</b></div>
      <div>Location: Marina Bay Sands</div>
      <div id="currentWeather">Loading...</div>
    </div>
  </aside>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const DEFAULT_CENTER = [1.2834, 103.8607]; // Marina Bay Sands
let map = L.map('map').setView(DEFAULT_CENTER, 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let waypoints=[], markers=[], polyline=L.polyline([], {color:'#ff7a00',weight:4}).addTo(map);

// ------------------------------
// Floating Menu Toggle (mobile)
// ------------------------------
const menuBtn=document.getElementById('menuToggle');
const sidePanel=document.getElementById('sidePanel');
menuBtn.addEventListener('click',()=>{ sidePanel.classList.toggle('show'); });

// ------------------------------
// Route Handling
// ------------------------------
function updateSavedList(){
  const saved=JSON.parse(localStorage.getItem('routes')||'[]');
  let html='';
  if(saved.length===0){html='No saved routes';}
  saved.forEach((r,i)=>{
    html+=`<div>${r.name} 
      <button onclick="loadRoute(${i})" class="small">Load</button>
      <button onclick="delRoute(${i})" class="small">Del</button></div>`;
  });
  document.getElementById('savedList').innerHTML=html;
}
function addWaypoint(latlng){
  const m=L.circleMarker(latlng,{radius:5,fillColor:'#ff7a00',color:'#fff',weight:2,fillOpacity:1}).addTo(map);
  markers.push(m);
  waypoints.push([latlng.lat, latlng.lng]);
  polyline.setLatLngs(waypoints);
  updateDistance();
}
map.on('click',e=>addWaypoint(e.latlng));

document.getElementById('undoBtn').onclick=()=>{
  if(markers.length){map.removeLayer(markers.pop());waypoints.pop();polyline.setLatLngs(waypoints);updateDistance();}
};
document.getElementById('clearBtn').onclick=()=>{
  markers.forEach(m=>map.removeLayer(m));markers=[];waypoints=[];polyline.setLatLngs([]);updateDistance();
};
document.getElementById('saveBtn').onclick=()=>{
  const name=document.getElementById('routeName').value||'Unnamed';
  const saved=JSON.parse(localStorage.getItem('routes')||'[]');
  saved.push({name,points:waypoints});
  localStorage.setItem('routes',JSON.stringify(saved));
  updateSavedList();
};

window.loadRoute=function(i){
  const saved=JSON.parse(localStorage.getItem('routes')||'[]')[i];
  if(!saved)return;
  markers.forEach(m=>map.removeLayer(m));markers=[];waypoints=[];polyline.setLatLngs([]);
  saved.points.forEach(p=>addWaypoint({lat:p[0],lng:p[1]}));
};
window.delRoute=function(i){
  let saved=JSON.parse(localStorage.getItem('routes')||'[]');
  saved.splice(i,1);localStorage.setItem('routes',JSON.stringify(saved));updateSavedList();
};
updateSavedList();

// ------------------------------
// Lap Counter
// ------------------------------
let laps=0;
document.getElementById('manualLap').onclick=()=>{laps++;document.getElementById('lapCount').textContent=laps;};
document.getElementById('resetLap').onclick=()=>{laps=0;document.getElementById('lapCount').textContent=laps;};

// ------------------------------
// Distance Calculator
// ------------------------------
function updateDistance(){
  if(waypoints.length < 2){
    document.getElementById('distance').textContent="0.00";
    return;
  }
  let dist=0;
  for(let i=1;i<waypoints.length;i++){
    const p1=waypoints[i-1], p2=waypoints[i];
    dist += map.distance(p1,p2);
  }
  document.getElementById('distance').textContent=(dist/1000).toFixed(2);
}

// ------------------------------
// Weather API (Open-Meteo, no key needed!)
// ------------------------------
async function setLocationByPostal() {
  const postal = document.getElementById('postalCode').value.trim();
  const status = document.getElementById('locationStatus');

  if (!postal) {
    status.textContent = "Please enter a postal code.";
    return;
  }

  status.textContent = "Looking up location‚Ä¶";

  try {
    // Nominatim API call
    const res = await fetch(`https://nominatim.openstreetmap.org/search?postalcode=${postal}&country=Singapore&format=json`);
    const data = await res.json();

    if (data.length === 0) {
      status.textContent = "No results found for that postal code.";
      return;
    }

    const { lat, lon, display_name } = data[0];

    // Update map center
    map.setView([lat, lon], 16);

    // Optionally mark the starting point
    if (window.startMarker) map.removeLayer(window.startMarker);
    window.startMarker = L.marker([lat, lon], { title: "Starting Point" }).addTo(map);

    // Update weather and UI
    status.textContent = `Set to: ${display_name}`;
    document.querySelector('.weather div:nth-child(2)').textContent = `Location: ${display_name}`;
    await loadWeatherForCoords(lat, lon);

  } catch (err) {
    console.error("Geocoding error:", err);
    status.textContent = "Error retrieving location.";
  }
}

document.getElementById('setLocationBtn').onclick = setLocationByPostal;

async function loadWeatherForCoords(lat, lon){
  try{
    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
    const data = await res.json();
    const temp=data.current_weather.temperature;
    const wind=data.current_weather.windspeed;
    const code=data.current_weather.weathercode;
    const desc=weatherCodeToText(code);
    document.getElementById('currentWeather').textContent =
      `${temp}¬∞C ‚Äî ${desc}, Wind ${wind} km/h`;
  }catch(err){
    document.getElementById('currentWeather').textContent="Weather unavailable";
    console.error("Weather API error:",err);
  }
}

function weatherCodeToText(code){
  const map={
    0:"Clear sky",1:"Mainly clear",2:"Partly cloudy",3:"Overcast",
    45:"Fog",48:"Rime fog",51:"Light drizzle",53:"Drizzle",55:"Dense drizzle",
    61:"Light rain",63:"Rain",65:"Heavy rain",
    71:"Light snow",73:"Snow",75:"Heavy snow",
    80:"Rain showers",81:"Rain showers",82:"Heavy showers",
    95:"Thunderstorm",96:"Thunderstorm w/ hail",99:"Severe thunderstorm"
  };
  return map[code]||"Unknown";
}

// Modify your initial load to call with the default center:
loadWeatherForCoords(DEFAULT_CENTER[0], DEFAULT_CENTER[1]);
</script>
</body>
</html>
